<!-- Sección de Evaluaciones -->
<div class="content-section">
  <!-- Loading indicator -->
  <div *ngIf="isLoading" class="text-center py-4">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Cargando...</span>
    </div>
  </div>

  <!-- Success/Error Messages -->
  <div *ngIf="successMessage" class="alert alert-success alert-dismissible fade show">
    {{ successMessage }}
    <button type="button" class="btn-close" (click)="successMessage = ''"></button>
  </div>

  <div *ngIf="errorMessage" class="alert alert-danger alert-dismissible fade show">
    {{ errorMessage }}
    <button type="button" class="btn-close" (click)="errorMessage = ''"></button>
  </div>

  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2><i class="fas fa-star me-2"></i>Gestión de Evaluaciones</h2>
    <div>
      <button class="btn btn-info me-2" (click)="openAutoEvaluateModal()">
        <i class="fas fa-robot me-2"></i>Evaluación Automática
      </button>
      <button class="btn btn-warning me-2" 
              data-bs-toggle="collapse" 
              data-bs-target="#originalityAnalysis"
              aria-expanded="false"
              (click)="toggleOriginalitySection()">
        <i class="fas fa-search-plus me-2"></i>Originalidad
      </button>
      <button class="btn btn-success me-2" (click)="downloadEvaluations()">
        <i class="fas fa-download me-2"></i>Descargar Evaluaciones
      </button>
      <button class="btn btn-primary" (click)="openCreateModal()">
        <i class="fas fa-plus me-2"></i>Crear Evaluación
      </button>
    </div>
  </div>
  
  <!-- Filtros -->
  <div class="card mb-3 filter-card">
    <div class="card-header">
      <h6 class="mb-0">
        <i class="fas fa-filter me-2"></i>Filtros de Evaluaciones
        <button class="btn btn-sm btn-outline-light float-end" (click)="clearAllFilters()">
          <i class="fas fa-times me-1"></i>Limpiar Filtros
        </button>
      </h6>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-3">
          <div class="form-group">
            <label for="classFilter" class="form-label">Clase:</label>
            <select id="classFilter" class="form-select" [(ngModel)]="filters.class" (change)="applyFilters()">
              <option value="">Todas las clases</option>
              <option *ngFor="let class of classes" [value]="class.name">{{ class.name }}</option>
            </select>
          </div>
        </div>
        <div class="col-md-3">
          <div class="form-group">
            <label for="assignmentFilter" class="form-label">Asignación:</label>
            <select id="assignmentFilter" class="form-select" [(ngModel)]="filters.assignment" (change)="applyFilters()">
              <option value="">Todas las asignaciones</option>
              <option *ngFor="let assignment of assignments" [value]="assignment.title">{{ assignment.title }}</option>
            </select>
          </div>
        </div>
        <div class="col-md-3">
          <div class="form-group">
            <label for="teamFilter" class="form-label">Equipo:</label>
            <select id="teamFilter" class="form-select" [(ngModel)]="filters.team" (change)="applyFilters()">
              <option value="">Todos los equipos</option>
              <option *ngFor="let team of teams" [value]="team.name">{{ team.name }}</option>
            </select>
          </div>
        </div>
        <div class="col-md-3">
          <div class="form-group">
            <label for="evaluatorFilter" class="form-label">Evaluador:</label>
            <select id="evaluatorFilter" class="form-select" [(ngModel)]="filters.evaluator" (change)="applyFilters()">
              <option value="">Todos los evaluadores</option>
              <option *ngFor="let evaluator of evaluators" [value]="evaluator.name">{{ evaluator.name }}</option>
            </select>
          </div>
        </div>
      </div>
      <div class="row mt-3">
        <div class="col-md-3">
          <div class="form-group">
            <label for="typeFilter" class="form-label">Tipo:</label>
            <select id="typeFilter" class="form-select" [(ngModel)]="filters.type" (change)="applyFilters()">
              <option value="">Todos los tipos</option>
              <option *ngFor="let type of uniqueEvaluationTypes" [value]="type">{{ getEvaluationTypeLabel(type) }}</option>
            </select>
          </div>
        </div>
        <div class="col-md-3">
          <div class="form-group">
            <label for="scoreFilter" class="form-label">Puntuación:</label>
            <select id="scoreFilter" class="form-select" [(ngModel)]="filters.score" (change)="applyFilters()">
              <option value="">Todas las puntuaciones</option>
              <option value="5">Excelente (5)</option>
              <option value="4-5">Muy Bueno (4-5)</option>
              <option value="3-4">Bueno (3-4)</option>
              <option value="2-3">Regular (2-3)</option>
              <option value="0-2">Deficiente (0-2)</option>
            </select>
          </div>
        </div>
        <div class="col-md-3">
          <div class="form-group">
            <label for="dateFromFilter" class="form-label">Fecha desde:</label>
            <input type="date" id="dateFromFilter" class="form-control" [(ngModel)]="filters.dateFrom" (change)="applyFilters()">
          </div>
        </div>
        <div class="col-md-3">
          <div class="form-group">
            <label for="dateToFilter" class="form-label">Fecha hasta:</label>
            <input type="date" id="dateToFilter" class="form-control" [(ngModel)]="filters.dateTo" (change)="applyFilters()">
          </div>
        </div>
      </div>
      <div class="row mt-3">
        <div class="col-md-6">
          <div class="filter-status-info">
            <div class="d-flex align-items-center">
              <span class="badge bg-primary me-2">{{ filteredEvaluations.length }} evaluaciones</span>
              <small class="text-muted">
                {{ filteredEvaluations.length === evaluations.length ? 'Sin filtros aplicados' : 'Filtros activos' }}
              </small>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="text-end">
            <button class="btn btn-outline-success" 
                    (click)="downloadFilteredEvaluations()" 
                    [disabled]="filteredEvaluations.length === 0">
              <i class="fas fa-download me-2"></i>Descargar Filtradas
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Sección de Análisis de Originalidad -->
  <div class="collapse mt-3" id="originalityAnalysis">
    <div class="card">
      <div class="card-header">
        <h6 class="mb-0">
          <i class="fas fa-search-plus me-2"></i>Análisis de Originalidad
        </h6>
      </div>
      <div class="card-body">
        <div class="row mb-3">
          <div class="col-md-6">
            <label for="assignmentSelectOriginality" class="form-label">Seleccionar Asignación:</label>
            <select id="assignmentSelectOriginality" 
                    class="form-select" 
                    [(ngModel)]="selectedAssignmentForOriginality">
              <option [ngValue]="null">Selecciona una asignación</option>
              <option *ngFor="let assignment of assignments" [ngValue]="assignment">
                {{ assignment.title }}
              </option>
            </select>
          </div>
          <div class="col-md-6 d-flex align-items-end">
            <div class="text-muted">
              <small>
                <i class="fas fa-info-circle me-2"></i>
                {{ getSubmissionsForOriginality().length }} entregas disponibles para análisis
              </small>
            </div>
          </div>
        </div>
        
        <app-originality-results 
          [assignmentId]="selectedAssignmentForOriginality?.id || 0"
          [assignmentTitle]="selectedAssignmentForOriginality?.title || ''"
          [submissions]="getSubmissionsForOriginality()">
        </app-originality-results>
      </div>
    </div>
  </div>

  <!-- Tabla de Evaluaciones -->
  <div class="table-responsive">
    <table class="table table-striped table-evaluations">
      <thead>
        <tr>
          <th width="6%">ID</th>
          <th width="20%">Entrega</th>
          <th width="15%">Equipo</th>
          <th width="12%">Puntuación</th>
          <th width="12%">Tipo</th>
          <th width="15%">Evaluador</th>
          <th width="14%">Fecha</th>
          <th width="18%">Acciones</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let evaluation of filteredEvaluations" [attr.data-id]="evaluation.id">
          <td>{{ evaluation.id }}</td>
          <td>
            <div class="text-truncate" style="max-width: 200px;">
              <strong>{{ evaluation.assignmentTitle || 'Sin asignación' }}</strong><br>
              <small class="text-muted">
                <i class="fab fa-github me-1"></i>
                <a [href]="evaluation.submissionUrl" target="_blank" class="text-decoration-none">
                  {{ evaluation.submissionUrl || 'Sin URL' }}
                </a>
              </small>
            </div>
          </td>
          <td>
            <span class="badge bg-light text-dark">{{ evaluation.teamName || 'Sin equipo' }}</span>
          </td>
          <td>
            <span class="badge fs-6 evaluation-score" [ngClass]="getScoreBadgeClass(evaluation.score)">
              {{ evaluation.score }}/5
            </span>
          </td>
          <td>
            <span class="badge evaluation-type-badge" [ngClass]="getTypeBadgeClass(evaluation.evaluationType)">
              {{ getEvaluationTypeLabel(evaluation.evaluationType) }}
            </span>
          </td>
          <td>{{ evaluation.evaluatorName || 'Sin evaluador' }}</td>
          <td>
            <small>{{ formatEvaluationDate(evaluation.evaluationDate) }}</small>
          </td>
          <td>
            <div class="action-buttons">
              <button class="btn btn-sm btn-info" (click)="openViewModal(evaluation)" title="Ver detalles">
                <i class="fas fa-eye"></i>
              </button>
              <button class="btn btn-sm btn-warning" (click)="openEditModal(evaluation)" title="Editar">
                <i class="fas fa-edit"></i>
              </button>
              <button class="btn btn-sm btn-danger" (click)="deleteEvaluation(evaluation.id)" title="Eliminar">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </td>
        </tr>
        <tr *ngIf="filteredEvaluations.length === 0">
          <td colspan="8" class="text-center text-muted py-4">
            <i class="fas fa-search me-2"></i>No se encontraron evaluaciones
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<!-- Modal para crear/editar evaluación -->
<div class="modal fade" [class.show]="showCreateModal" [style.display]="showCreateModal ? 'block' : 'none'" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-star me-2"></i>
          {{ editingEvaluation ? 'Editar Evaluación' : 'Nueva Evaluación' }}
        </h5>
        <button type="button" class="btn-close" (click)="closeModals()"></button>
      </div>
      <div class="modal-body">
        <form>
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label for="submissionSelect" class="form-label">Entrega</label>
                <select id="submissionSelect" class="form-select" [(ngModel)]="newEvaluation.submissionId" name="submissionId" required>
                  <option value="0">Selecciona una entrega</option>
                  <option *ngFor="let submission of submissions" [value]="submission.id">
                    {{ submission.id }} - {{ submission.assignmentTitle }} - {{ submission.teamName }}
                  </option>
                </select>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label for="evaluatorSelect" class="form-label">Evaluador</label>
                <select id="evaluatorSelect" class="form-select" [(ngModel)]="newEvaluation.evaluatorId" name="evaluatorId" required>
                  <option value="0">Selecciona un evaluador</option>
                  <option *ngFor="let evaluator of evaluators" [value]="evaluator.id">
                    {{ evaluator.name }}
                  </option>
                </select>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label for="scoreInput" class="form-label">Puntuación</label>
                <input type="number" id="scoreInput" class="form-control score-input" 
                       [(ngModel)]="newEvaluation.score" name="score" 
                       min="0" max="5" step="0.1" required>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label for="typeSelect" class="form-label">Tipo de Evaluación</label>
                <select id="typeSelect" class="form-select" [(ngModel)]="newEvaluation.evaluationType" name="evaluationType" required>
                  <option *ngFor="let type of uniqueEvaluationTypes" [value]="type">{{ getEvaluationTypeLabel(type) }}</option>
                </select>
              </div>
            </div>
          </div>
          <div class="mb-3">
            <label for="criteriaInput" class="form-label">Criterios de Evaluación</label>
            <textarea id="criteriaInput" class="form-control" rows="4" 
                      [(ngModel)]="newEvaluation.criteria" name="criteria"
                      placeholder="Describe los criterios utilizados para esta evaluación..."></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeModals()">Cancelar</button>
        <button type="button" class="btn btn-primary" (click)="saveEvaluation()" [disabled]="isLoading">
          <span *ngIf="isLoading" class="spinner-border spinner-border-sm me-2"></span>
          {{ editingEvaluation ? 'Actualizar' : 'Crear' }}
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal para evaluación automática -->
<div class="modal fade" [class.show]="showAutoEvaluateModal" [style.display]="showAutoEvaluateModal ? 'block' : 'none'" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-robot me-2"></i>Evaluación Automática
        </h5>
        <button type="button" class="btn-close" (click)="closeModals()"></button>
      </div>
      <div class="modal-body">
        <div class="auto-evaluate-section">
          <h6><i class="fas fa-info-circle me-2"></i>Tipos de Evaluación Automática</h6>
          <p class="mb-3">Selecciona el tipo de evaluación automática que deseas realizar:</p>
          
          <div class="mb-4">
            <label for="submissionSelectAuto" class="form-label">Seleccionar Entrega</label>
            <select id="submissionSelectAuto" class="form-select" [(ngModel)]="selectedSubmission">
              <option [ngValue]="null">Selecciona una entrega</option>
              <option *ngFor="let submission of submissions" [ngValue]="submission">
                {{ submission.id }} - {{ submission.assignmentTitle }} - {{ submission.teamName }}
              </option>
            </select>
          </div>

          <div class="row">
            <div class="col-md-6">
              <div class="card h-100">
                <div class="card-header bg-info text-white">
                  <i class="fas fa-calendar-alt me-2"></i>Evaluación de Cronograma
                </div>
                <div class="card-body">
                  <p class="card-text">Evalúa el cumplimiento del cronograma basándose en los commits de GitHub.</p>
                  <ul class="list-unstyled">
                    <li><i class="fas fa-check text-success me-2"></i>Analiza commits a tiempo</li>
                    <li><i class="fas fa-check text-success me-2"></i>Calcula penalizaciones por retrasos</li>
                    <li><i class="fas fa-check text-success me-2"></i>Evaluación objetiva automática</li>
                  </ul>
                  <button class="btn btn-info w-100" 
                          (click)="executeAutoEvaluation('SCHEDULER')" 
                          [disabled]="!selectedSubmission || isLoading">
                    <span *ngIf="isLoading" class="spinner-border spinner-border-sm me-2"></span>
                    <i class="fas fa-play me-2"></i>Evaluar Cronograma
                  </button>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="card h-100">
                <div class="card-header bg-success text-white">
                  <i class="fas fa-code me-2"></i>Evaluación de Buenas Prácticas
                </div>
                <div class="card-body">
                  <p class="card-text">Evalúa la calidad del código y buenas prácticas de programación.</p>
                  <ul class="list-unstyled">
                    <li><i class="fas fa-check text-success me-2"></i>Analiza estructura del código</li>
                    <li><i class="fas fa-check text-success me-2"></i>Verifica patrones de diseño</li>
                    <li><i class="fas fa-check text-success me-2"></i>Evaluación con/sin IA</li>
                  </ul>
                  
                  <div class="form-check mb-3">
                    <input type="checkbox" class="form-check-input" id="useIA" [(ngModel)]="autoEvaluationOptions.usingIA">
                    <label class="form-check-label" for="useIA">
                      <i class="fas fa-brain me-2"></i>Usar Inteligencia Artificial
                    </label>
                  </div>
                  
                  <!-- Warning for AI analysis -->
                  <div *ngIf="autoEvaluationOptions.usingIA" class="alert alert-warning py-2 mb-3">
                    <small>
                      <i class="fas fa-exclamation-triangle me-2"></i>
                      <strong>Advertencia:</strong> El análisis con IA puede tardar varios minutos. 
                      Se te notificará cuando esté completo.
                    </small>
                  </div>
                  
                  <button class="btn btn-success w-100" 
                          (click)="executeAutoEvaluation(autoEvaluationOptions.usingIA ? 'GOOD_PRACTICES_AI' : 'GOOD_PRACTICES')" 
                          [disabled]="!selectedSubmission || isLoading">
                    <span *ngIf="isLoading" class="spinner-border spinner-border-sm me-2"></span>
                    <i class="fas fa-play me-2"></i>Evaluar Buenas Prácticas
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeModals()">Cerrar</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal para ver detalles de evaluación -->
<div class="modal fade" [class.show]="showViewModal" [style.display]="showViewModal ? 'block' : 'none'" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-eye me-2"></i>Detalles de Evaluación #{{ editingEvaluation?.id }}
        </h5>
        <button type="button" class="btn-close" (click)="closeModals()"></button>
      </div>
      <div class="modal-body" *ngIf="editingEvaluation">
        <div class="row mb-4">
          <div class="col-md-6">
            <h6><i class="fas fa-info-circle me-2"></i>Información General</h6>
            <table class="table table-borderless">
              <tr>
                <td><strong>ID:</strong></td>
                <td>{{ editingEvaluation.id }}</td>
              </tr>
              <tr>
                <td><strong>Puntuación:</strong></td>
                <td>
                  <span class="badge fs-6" [ngClass]="getScoreBadgeClass(editingEvaluation.score)">
                    {{ editingEvaluation.score }}/5
                  </span>
                </td>
              </tr>
              <tr>
                <td><strong>Tipo:</strong></td>
                <td>
                  <span class="badge" [ngClass]="getTypeBadgeClass(editingEvaluation.evaluationType)">
                    {{ getEvaluationTypeLabel(editingEvaluation.evaluationType) }}
                  </span>
                </td>
              </tr>
              <tr>
                <td><strong>Evaluador:</strong></td>
                <td>{{ editingEvaluation.evaluatorName }}</td>
              </tr>
              <tr>
                <td><strong>Fecha:</strong></td>
                <td>{{ formatEvaluationDate(editingEvaluation.evaluationDate) }}</td>
              </tr>
            </table>
          </div>
          <div class="col-md-6">
            <h6><i class="fas fa-file-alt me-2"></i>Información de Entrega</h6>
            <table class="table table-borderless">
              <tr>
                <td><strong>Asignación:</strong></td>
                <td>{{ editingEvaluation.assignmentTitle }}</td>
              </tr>
              <tr>
                <td><strong>Equipo:</strong></td>
                <td>{{ editingEvaluation.teamName }}</td>
              </tr>
              <tr>
                <td><strong>Repositorio:</strong></td>
                <td>
                  <a [href]="editingEvaluation.submissionUrl" target="_blank" class="text-decoration-none">
                    <i class="fab fa-github me-1"></i>{{ editingEvaluation.submissionUrl }}
                  </a>
                </td>
              </tr>
            </table>
          </div>
        </div>
        
        <div class="mb-4">
          <h6><i class="fas fa-list-check me-2"></i>Criterios de Evaluación</h6>
          <div class="criteria-display" [innerHTML]="formatCriteriaDisplay(editingEvaluation)"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeModals()">Cerrar</button>
        <button type="button" class="btn btn-warning" (click)="openEditModal(editingEvaluation!)">
          <i class="fas fa-edit me-2"></i>Editar
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal backdrop -->
<div class="modal-backdrop fade" 
     [class.show]="showCreateModal || showAutoEvaluateModal || showViewModal || showAutoEvaluationResults"
     *ngIf="showCreateModal || showAutoEvaluateModal || showViewModal || showAutoEvaluationResults">
</div>

<!-- Resultados de evaluación automática -->
<div class="modal fade" [class.show]="showAutoEvaluationResults" [style.display]="showAutoEvaluationResults ? 'block' : 'none'" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-check-circle me-2"></i>Resultados de Evaluación Automática
        </h5>
        <button type="button" class="btn-close" (click)="closeModals()"></button>
      </div>
      <div class="modal-body" *ngIf="autoEvaluationResult">
        <div class="alert alert-success">
          <h6><i class="fas fa-check-circle me-2"></i>Evaluación Automática Completada</h6>
          <p>La evaluación se ha completado exitosamente. Los resultados se han guardado en el sistema.</p>
        </div>
        
        <div class="row">
          <div class="col-md-12">
            <div class="criteria-display" [innerHTML]="formatCriteriaDisplay(autoEvaluationResult)"></div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" (click)="closeModals()">Entendido</button>
      </div>
    </div>
  </div>
</div>
