<div class="component-container">
  <div class="section-header">
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <h2 class="section-title">
          <i class="fas fa-star me-2"></i>Gestión de Evaluaciones
        </h2>
        <p class="section-subtitle text-muted">Administra las evaluaciones y calificaciones del sistema</p>
      </div>
      <div class="section-actions">
        <button class="btn btn-outline-primary me-2" (click)="loadData()">
          <i class="fas fa-refresh me-2"></i>Recargar
        </button>
        <button class="btn btn-success me-2" (click)="downloadAll()">
          <i class="fas fa-download me-2"></i>Descargar Todas
        </button>
        <button class="btn btn-primary" (click)="showCreateModal()">
          <i class="fas fa-plus me-2"></i>Nueva Evaluación
        </button>
      </div>
    </div>
  </div>
  
  <div class="section-body">
    <!-- Filtros -->
    <div class="card mb-3 filter-card" *ngIf="!loading">
      <div class="card-header">
        <h6 class="mb-0">
          <i class="fas fa-filter me-2"></i>Filtros de Evaluaciones
          <button class="btn btn-sm btn-outline-light float-end" (click)="clearAllFilters()">
            <i class="fas fa-times me-1"></i>Limpiar Filtros
          </button>
        </h6>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-3">
            <div class="form-group">
              <label for="classFilter" class="form-label">Clase:</label>
              <select id="classFilter" 
                      class="form-select" 
                      [(ngModel)]="filters.class"
                      (change)="applyFilters()">
                <option value="">Todas las clases</option>
                <option *ngFor="let className of classOptions" [value]="className">
                  {{ className }}
                </option>
              </select>
            </div>
          </div>
          <div class="col-md-3">
            <div class="form-group">
              <label for="assignmentFilter" class="form-label">Asignación:</label>
              <select id="assignmentFilter" 
                      class="form-select" 
                      [(ngModel)]="filters.assignment"
                      (change)="applyFilters()">
                <option value="">Todas las asignaciones</option>
                <option *ngFor="let assignment of assignmentOptions" [value]="assignment">
                  {{ assignment }}
                </option>
              </select>
            </div>
          </div>
          <div class="col-md-3">
            <div class="form-group">
              <label for="teamFilter" class="form-label">Equipo:</label>
              <select id="teamFilter" 
                      class="form-select" 
                      [(ngModel)]="filters.team"
                      (change)="applyFilters()">
                <option value="">Todos los equipos</option>
                <option *ngFor="let team of teamOptions" [value]="team">
                  {{ team }}
                </option>
              </select>
            </div>
          </div>
          <div class="col-md-3">
            <div class="form-group">
              <label for="evaluatorFilter" class="form-label">Evaluador:</label>
              <select id="evaluatorFilter" 
                      class="form-select" 
                      [(ngModel)]="filters.evaluator"
                      (change)="applyFilters()">
                <option value="">Todos los evaluadores</option>
                <option *ngFor="let evaluator of evaluatorOptions" [value]="evaluator">
                  {{ evaluator }}
                </option>
              </select>
            </div>
          </div>
        </div>
        <div class="row mt-3">
          <div class="col-md-3">
            <div class="form-group">
              <label for="typeFilter" class="form-label">Tipo:</label>
              <select id="typeFilter" 
                      class="form-select" 
                      [(ngModel)]="filters.type"
                      (change)="applyFilters()">
                <option value="">Todos los tipos</option>
                <option value="MANUAL">Manual</option>
                <option value="AUTOMATIC">Automática</option>
              </select>
            </div>
          </div>
          <div class="col-md-3">
            <div class="form-group">
              <label for="scoreFilter" class="form-label">Puntuación:</label>
              <select id="scoreFilter" 
                      class="form-select" 
                      [(ngModel)]="filters.score"
                      (change)="applyFilters()">
                <option value="">Todas las puntuaciones</option>
                <option value="5">Excelente (5)</option>
                <option value="4-5">Muy Bueno (4-5)</option>
                <option value="3-4">Bueno (3-4)</option>
                <option value="2-3">Regular (2-3)</option>
                <option value="0-2">Deficiente (0-2)</option>
              </select>
            </div>
          </div>
          <div class="col-md-3">
            <div class="form-group">
              <label for="dateFromFilter" class="form-label">Fecha desde:</label>
              <input type="date" 
                     id="dateFromFilter" 
                     class="form-control" 
                     [(ngModel)]="filters.dateFrom"
                     (change)="applyFilters()">
            </div>
          </div>
          <div class="col-md-3">
            <div class="form-group">
              <label for="dateToFilter" class="form-label">Fecha hasta:</label>
              <input type="date" 
                     id="dateToFilter" 
                     class="form-control" 
                     [(ngModel)]="filters.dateTo"
                     (change)="applyFilters()">
            </div>
          </div>
        </div>
        <div class="row mt-3">
          <div class="col-md-6">
            <div class="filter-status-info">
              <div class="d-flex align-items-center">
                <span class="badge bg-primary me-2">{{ filteredEvaluations.length }} evaluaciones</span>
                <small class="text-muted">{{ getFilterStatusText() }}</small>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="text-end">
              <button class="btn btn-outline-success" 
                      (click)="downloadFiltered()" 
                      [disabled]="filteredEvaluations.length === 0">
                <i class="fas fa-download me-2"></i>Descargar Filtradas
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Loading State -->
    <div *ngIf="loading" class="text-center py-5">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Cargando...</span>
      </div>
      <p class="mt-3 text-muted">Cargando evaluaciones...</p>
    </div>

    <!-- Data Table -->
    <div *ngIf="!loading" class="table-responsive">
      <table class="table table-striped table-evaluations">
        <thead>
          <tr>
            <th width="6%">ID</th>
            <th width="20%">Entrega</th>
            <th width="15%">Clase</th>
            <th width="12%">Puntuación</th>
            <th width="15%">Evaluador</th>
            <th width="14%">Fecha Evaluación</th>
            <th width="18%">Acciones</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let evaluation of filteredEvaluations" [attr.data-id]="evaluation.id">
            <td>{{ evaluation.id }}</td>
            <td class="text-truncate" [title]="getSubmissionInfo(evaluation)">
              {{ getSubmissionInfo(evaluation) }}
            </td>
            <td class="text-truncate" [title]="getClassName(evaluation)">
              {{ getClassName(evaluation) }}
            </td>
            <td>
              <span class="badge" [ngClass]="getScoreBadgeClass(evaluation.score)">
                {{ evaluation.score }}/5
              </span>
              <div *ngIf="evaluation.evaluationType" class="mt-1">
                <small class="badge" [ngClass]="getTypeBadgeClass(evaluation.evaluationType)">
                  {{ evaluation.evaluationType === 'AUTOMATIC' ? 'Automática' : 'Manual' }}
                </small>
              </div>
            </td>
            <td class="text-truncate" [title]="getEvaluatorName(evaluation)">
              {{ getEvaluatorName(evaluation) }}
            </td>
            <td class="date-display">
              {{ formatEvaluationDate(evaluation) }}
            </td>
            <td class="action-buttons">
              <button class="btn btn-sm btn-outline-info me-1" 
                      (click)="viewEvaluation(evaluation.id)" 
                      title="Ver detalles">
                <i class="fas fa-eye"></i>
              </button>
              <button class="btn btn-sm btn-outline-warning me-1" 
                      (click)="editEvaluation(evaluation.id)" 
                      title="Editar">
                <i class="fas fa-edit"></i>
              </button>
              <button class="btn btn-sm btn-outline-danger" 
                      (click)="deleteEvaluation(evaluation.id)" 
                      title="Eliminar">
                <i class="fas fa-trash"></i>
              </button>
            </td>
          </tr>
          <tr *ngIf="filteredEvaluations.length === 0">
            <td colspan="7" class="text-center text-muted py-4">
              <i class="fas fa-inbox fa-2x mb-3 d-block"></i>
              No hay evaluaciones registradas
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Modal para crear evaluación -->
<div class="modal" [class.show]="showCreateEvaluationModal" 
     [style.display]="showCreateEvaluationModal ? 'block' : 'none'" 
     *ngIf="showCreateEvaluationModal">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-star me-2"></i>Crear Evaluación
        </h5>
        <button type="button" class="btn-close" (click)="closeCreateModal()"></button>
      </div>
      <form (ngSubmit)="createEvaluation()" #createForm="ngForm">
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Entrega *</label>
            <select class="form-select" 
                    [(ngModel)]="newEvaluation.submissionId" 
                    name="submissionId" 
                    required>
              <option value="0">Seleccione una entrega</option>
              <option *ngFor="let submission of submissions" 
                      [value]="submission.id">
                {{ submission.assignmentTitle }} - {{ submission.teamName }}
              </option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Evaluador *</label>
            <select class="form-select" 
                    [(ngModel)]="newEvaluation.evaluatorId" 
                    name="evaluatorId" 
                    required>
              <option value="0">Seleccione un evaluador</option>
              <option *ngFor="let evaluator of evaluators" 
                      [value]="evaluator.id">
                {{ evaluator.firstName }} {{ evaluator.lastName }}
              </option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Puntuación *</label>
            <input type="number" 
                   class="form-control" 
                   [(ngModel)]="newEvaluation.score" 
                   name="score" 
                   min="0" 
                   max="5" 
                   step="0.1" 
                   required />
            <div class="form-text">Puntuación de 0 a 5</div>
          </div>
          <div class="mb-3">
            <label class="form-label">Tipo de Evaluación *</label>
            <select class="form-select" 
                    [(ngModel)]="newEvaluation.evaluationType" 
                    name="evaluationType" 
                    required>
              <option value="">Seleccione un tipo</option>
              <option value="MANUAL">Manual</option>
              <option value="AUTOMATIC">Automática</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Criterios (JSON)</label>
            <textarea class="form-control" 
                      [(ngModel)]="newEvaluation.criteria" 
                      name="criteria" 
                      rows="3"
                      placeholder='{"criterio1": "valor1", "criterio2": "valor2"}'></textarea>
            <div class="form-text">Criterios de evaluación en formato JSON</div>
          </div>
          <div class="mb-3">
            <label class="form-label">Retroalimentación</label>
            <textarea class="form-control" 
                      [(ngModel)]="newEvaluation.feedback" 
                      name="feedback" 
                      rows="3"
                      placeholder="Comentarios sobre la evaluación..."></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="closeCreateModal()">
            <i class="fas fa-times me-2"></i>Cancelar
          </button>
          <button type="submit" 
                  class="btn btn-primary" 
                  [disabled]="!createForm.form.valid || submitting">
            <i class="fas fa-plus me-2"></i>
            <span *ngIf="!submitting">Crear Evaluación</span>
            <span *ngIf="submitting">
              <span class="spinner-border spinner-border-sm me-2"></span>Creando...
            </span>
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal para ver detalles -->
<div class="modal" [class.show]="showViewEvaluationModal" 
     [style.display]="showViewEvaluationModal ? 'block' : 'none'" 
     *ngIf="showViewEvaluationModal && selectedEvaluation">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Detalles de la Evaluación</h5>
        <button type="button" class="btn-close" (click)="closeViewModal()"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col-md-6">
            <div class="detail-item mb-3">
              <strong class="detail-label">ID:</strong> 
              <span class="detail-value">{{ selectedEvaluation.id }}</span>
            </div>
            <div class="detail-item mb-3">
              <strong class="detail-label">Entrega:</strong> 
              <span class="detail-value">{{ getSubmissionInfo(selectedEvaluation) }}</span>
            </div>
            <div class="detail-item mb-3">
              <strong class="detail-label">Clase:</strong> 
              <span class="detail-value">{{ getClassName(selectedEvaluation) }}</span>
            </div>
            <div class="detail-item mb-3">
              <strong class="detail-label">Evaluador:</strong> 
              <span class="detail-value">{{ getEvaluatorName(selectedEvaluation) }}</span>
            </div>
          </div>
          <div class="col-md-6">
            <div class="detail-item mb-3">
              <strong class="detail-label">Puntuación:</strong> 
              <span class="badge" [ngClass]="getScoreBadgeClass(selectedEvaluation.score)">
                {{ selectedEvaluation.score }}/5
              </span>
            </div>
            <div class="detail-item mb-3">
              <strong class="detail-label">Tipo:</strong> 
              <span class="badge" [ngClass]="getTypeBadgeClass(selectedEvaluation.evaluationType)">
                {{ selectedEvaluation.evaluationType === 'AUTOMATIC' ? 'Automática' : 'Manual' }}
              </span>
            </div>
            <div class="detail-item mb-3">
              <strong class="detail-label">Fecha de Evaluación:</strong> 
              <span class="detail-value">{{ formatEvaluationDate(selectedEvaluation) }}</span>
            </div>
          </div>
        </div>
        
        <!-- Criterios de evaluación -->
        <div *ngIf="selectedEvaluation.criteria || selectedEvaluation.criteriaJson" class="mt-4">
          <div [innerHTML]="formatCriteriaDisplay(selectedEvaluation)"></div>
        </div>
        
        <!-- Retroalimentación -->
        <div *ngIf="selectedEvaluation.feedback" class="mt-4">
          <div class="card">
            <div class="card-header bg-info text-white">
              <i class="fas fa-comments me-2"></i>Retroalimentación
            </div>
            <div class="card-body">
              <p class="mb-0">{{ selectedEvaluation.feedback }}</p>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeViewModal()">
          <i class="fas fa-times me-2"></i>Cerrar
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal para editar evaluación -->
<div class="modal" [class.show]="showEditEvaluationModal" 
     [style.display]="showEditEvaluationModal ? 'block' : 'none'" 
     *ngIf="showEditEvaluationModal && selectedEvaluation">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-edit me-2"></i>Editar Evaluación
        </h5>
        <button type="button" class="btn-close" (click)="closeEditModal()"></button>
      </div>
      <form (ngSubmit)="updateEvaluation()" #editForm="ngForm">
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Entrega *</label>
            <select class="form-select" 
                    [(ngModel)]="editingEvaluation.submissionId" 
                    name="submissionId" 
                    required>
              <option value="0">Seleccione una entrega</option>
              <option *ngFor="let submission of submissions" 
                      [value]="submission.id">
                {{ submission.assignmentTitle }} - {{ submission.teamName }}
              </option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Evaluador *</label>
            <select class="form-select" 
                    [(ngModel)]="editingEvaluation.evaluatorId" 
                    name="evaluatorId" 
                    required>
              <option value="0">Seleccione un evaluador</option>
              <option *ngFor="let evaluator of evaluators" 
                      [value]="evaluator.id">
                {{ evaluator.firstName }} {{ evaluator.lastName }}
              </option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Puntuación *</label>
            <input type="number" 
                   class="form-control" 
                   [(ngModel)]="editingEvaluation.score" 
                   name="score" 
                   min="0" 
                   max="5" 
                   step="0.1" 
                   required />
            <div class="form-text">Puntuación de 0 a 5</div>
          </div>
          <div class="mb-3">
            <label class="form-label">Tipo de Evaluación *</label>
            <select class="form-select" 
                    [(ngModel)]="editingEvaluation.evaluationType" 
                    name="evaluationType" 
                    required>
              <option value="">Seleccione un tipo</option>
              <option value="MANUAL">Manual</option>
              <option value="AUTOMATIC">Automática</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Criterios (JSON)</label>
            <textarea class="form-control" 
                      [(ngModel)]="editingEvaluation.criteria" 
                      name="criteria" 
                      rows="3"
                      placeholder='{"criterio1": "valor1", "criterio2": "valor2"}'></textarea>
            <div class="form-text">Criterios de evaluación en formato JSON</div>
          </div>
          <div class="mb-3">
            <label class="form-label">Retroalimentación</label>
            <textarea class="form-control" 
                      [(ngModel)]="editingEvaluation.feedback" 
                      name="feedback" 
                      rows="3"
                      placeholder="Comentarios sobre la evaluación..."></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="closeEditModal()">
            <i class="fas fa-times me-2"></i>Cancelar
          </button>
          <button type="submit" 
                  class="btn btn-primary" 
                  [disabled]="!editForm.form.valid || submitting">
            <i class="fas fa-save me-2"></i>
            <span *ngIf="!submitting">Actualizar</span>
            <span *ngIf="submitting">
              <span class="spinner-border spinner-border-sm me-2"></span>Actualizando...
            </span>
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Backdrop para modales -->
<div class="modal-backdrop" 
     [class.show]="showCreateEvaluationModal || showViewEvaluationModal || showEditEvaluationModal"
     [style.display]="(showCreateEvaluationModal || showViewEvaluationModal || showEditEvaluationModal) ? 'block' : 'none'"
     (click)="closeAllModals()">
</div>
