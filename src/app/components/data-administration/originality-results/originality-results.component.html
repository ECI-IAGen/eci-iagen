<div class="originality-analysis">
  <div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h5 class="mb-0">
        <i class="fas fa-search-plus"></i>
        Análisis de Originalidad
      </h5>
      <div class="header-actions">
        <span class="badge me-2" 
              [style.background-color]="jplagHealthy ? '#28a745' : '#dc3545'"
              [title]="jplagHealthy ? 'Servicio JPlag disponible' : 'Servicio JPlag no disponible'">
          <i class="fas" [class.fa-check-circle]="jplagHealthy" [class.fa-exclamation-circle]="!jplagHealthy"></i>
          {{ jplagHealthy ? 'Servicio OK' : 'Servicio OFF' }}
        </span>
        <button 
          class="btn btn-primary"
          [disabled]="loading || !submissions || submissions.length < 2 || !jplagHealthy"
          (click)="analyzeOriginality()">
          <i class="fas fa-play" *ngIf="!loading"></i>
          <i class="fas fa-spinner fa-spin" *ngIf="loading"></i>
          {{ loading ? 'Analizando...' : 'Analizar Originalidad' }}
        </button>
      </div>
    </div>
    
    <div class="card-body">
      <!-- Requirements Info -->
      <div class="alert alert-info mb-3" *ngIf="!originalityResults">
        <h6><i class="fas fa-info-circle"></i> Análisis de Originalidad con JPlag</h6>
        <p class="mb-2">Este análisis detecta similitudes en el código fuente entre diferentes entregas usando la herramienta JPlag.</p>
        <ul class="mb-0">
          <li><strong>Repositorios requeridos:</strong> Mínimo 2 entregas</li>
          <li><strong>Idioma soportado:</strong> Java</li>
          <li><strong>Tiempo estimado:</strong> 1-3 minutos dependiendo del tamaño de los repositorios</li>
        </ul>
      </div>

      <!-- Submissions Info -->
      <div class="alert alert-light border mb-3" *ngIf="submissions && submissions.length > 0">
        <h6><i class="fas fa-list"></i> Entregas a Analizar</h6>
        <p class="mb-2"><strong>{{ submissions.length }}</strong> entregas seleccionadas:</p>
        <div class="row">
          <div class="col-md-6" *ngFor="let submission of submissions; let i = index">
            <div class="submission-item mb-2">
              <i class="fas fa-users me-2"></i>
              <strong>{{ submission.teamName }}</strong>
              <small class="text-muted d-block ms-3">
                <i class="fab fa-github me-1"></i>
                <a [href]="submission.repositoryUrl" target="_blank" class="text-decoration-none">
                  {{ submission.repositoryUrl }}
                </a>
              </small>
            </div>
          </div>
        </div>
      </div>

      <!-- Error Message -->
      <div class="alert alert-danger" *ngIf="error">
        <i class="fas fa-exclamation-triangle"></i>
        {{ error }}
        <div class="mt-2" *ngIf="!jplagHealthy">
          <small>
            <strong>Sugerencia:</strong> Verifica que el servicio JPlag esté ejecutándose en el puerto 8082.
          </small>
        </div>
      </div>

      <!-- Loading State -->
      <div class="text-center py-4" *ngIf="loading">
        <div class="spinner-border text-primary mb-3" role="status">
          <span class="visually-hidden">Analizando...</span>
        </div>
        <h6>Analizando originalidad...</h6>
        <p class="text-muted">
          <i class="fas fa-download me-2"></i>Clonando repositorios y analizando código fuente
        </p>
        <div class="progress" style="height: 6px;">
          <div class="progress-bar progress-bar-animated progress-bar-striped" 
               style="width: 100%" role="progressbar"></div>
        </div>
      </div>

      <!-- Results -->
      <div *ngIf="originalityResults && !loading">
        <!-- Summary Card -->
        <div class="alert mb-4" [style.background-color]="getOverallRiskColor() + '20'" 
             [style.border-color]="getOverallRiskColor()">
          <div class="row align-items-center">
            <div class="col-md-8">
              <h6><i class="fas fa-chart-pie me-2"></i> Resumen del Análisis</h6>
              <p class="mb-1"><strong>Assignment:</strong> {{ originalityResults.assignmentTitle }}</p>
              <p class="mb-1"><strong>Comparaciones realizadas:</strong> {{ originalityResults.comparisons.length }}</p>
              <p class="mb-0"><strong>Nivel de originalidad general:</strong> 
                <span class="badge badge-pill ms-2" 
                      [style.background-color]="getOverallRiskColor()"
                      style="color: white;">
                  {{ getOverallRiskLevel() }}
                </span>
              </p>
            </div>
            <div class="col-md-4">
              <div class="risk-summary">
                <div class="risk-item" *ngIf="getRiskSummary().high > 0">
                  <span class="badge bg-danger">{{ getRiskSummary().high }} Baja originalidad</span>
                </div>
                <div class="risk-item" *ngIf="getRiskSummary().medium > 0">
                  <span class="badge bg-warning">{{ getRiskSummary().medium }} Originalidad media</span>
                </div>
                <div class="risk-item" *ngIf="getRiskSummary().low > 0">
                  <span class="badge bg-info">{{ getRiskSummary().low }} Originalidad aceptable</span>
                </div>
                <div class="risk-item" *ngIf="getRiskSummary().minimal > 0">
                  <span class="badge bg-success">{{ getRiskSummary().minimal }} Alta originalidad</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Comparisons Table -->
        <div *ngIf="originalityResults.comparisons && originalityResults.comparisons.length > 0">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h6><i class="fas fa-table me-2"></i>Comparaciones de Originalidad</h6>
            <div class="btn-group">
              <!-- Botón para reporte HTML -->
              <button 
                class="btn btn-outline-primary btn-sm me-2" 
                (click)="openReportInNewWindow()"
                *ngIf="hasReport()"
                title="Abrir reporte detallado en nueva ventana">
                <i class="fas fa-external-link-alt me-2"></i>Ver Reporte Completo
              </button>
              
              <!-- Botón de exportar CSV -->
              <button class="btn btn-outline-success btn-sm" (click)="exportResults()">
                <i class="fas fa-download me-2"></i>Exportar CSV
              </button>
              
              <!-- Botón temporal de debugging -->
              <button class="btn btn-outline-warning btn-sm ms-2" (click)="debugComparisons()">
                <i class="fas fa-bug me-2"></i>Debug
              </button>
            </div>
          </div>
          
          <div class="table-responsive">
            <table class="table table-striped table-hover">
              <thead class="table-dark">
                <tr>
                  <th width="22%">Equipo 1</th>
                  <th width="22%">Equipo 2</th>
                  <th width="18%">Originalidad</th>
                  <th width="23%">Nivel de Originalidad</th>
                  <th width="15%">Acciones</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let comparison of originalityResults.comparisons; let i = index"
                    [class]="'table-row-' + getSimilarityLevel(comparison.similarity).toLowerCase()">
                  <td>
                    <div class="team-info">
                      <strong>{{ getTeamName(comparison.submissionId1) }}</strong>
                      <small class="text-muted d-block">
                        ID: {{ comparison.submissionId1 }}
                      </small>
                    </div>
                  </td>
                  <td>
                    <div class="team-info">
                      <strong>{{ getTeamName(comparison.submissionId2) }}</strong>
                      <small class="text-muted d-block">
                        ID: {{ comparison.submissionId2 }}
                      </small>
                    </div>
                  </td>
                  <td>
                    <div class="originality-display">
                      <!-- Mostrar Originalidad como métrica principal -->
                      <span class="badge badge-pill fs-6" 
                            [style.background-color]="getOriginalityColor(comparison.similarity)"
                            style="color: white;">
                        {{ getOriginalityPercentage(comparison.similarity).toFixed(1) }}% Original
                      </span>
                      <!-- Mostrar también la similaridad como información secundaria -->
                      <small class="text-muted d-block mt-1">
                        ({{ getSimilarityPercentage(comparison.similarity).toFixed(1) }}% similar)
                      </small>
                      <div class="progress mt-1" style="height: 4px;">
                        <div class="progress-bar" 
                             [style.width.%]="getOriginalityPercentage(comparison.similarity)"
                             [style.background-color]="getOriginalityColor(comparison.similarity)">
                        </div>
                      </div>
                    </div>
                  </td>
                  <td>
                    <span class="originality-level" [style.color]="getOriginalityColor(comparison.similarity)">
                      <i class="fas fa-exclamation-triangle me-1" *ngIf="getOriginalityPercentage(comparison.similarity) <= 20"></i>
                      <i class="fas fa-info-circle me-1" *ngIf="getOriginalityPercentage(comparison.similarity) > 20 && getOriginalityPercentage(comparison.similarity) <= 60"></i>
                      <i class="fas fa-check-circle me-1" *ngIf="getOriginalityPercentage(comparison.similarity) > 60"></i>
                      {{ getOriginalityLabel(comparison.similarity) }}
                    </span>
                  </td>
                  <td>
                    <div class="action-buttons">
                      <a [href]="getRepositoryUrl(comparison.submissionId1)" 
                         target="_blank" 
                         class="btn btn-sm btn-outline-primary me-1" 
                         title="Ver repositorio 1">
                        <i class="fab fa-github"></i>
                      </a>
                      <a [href]="getRepositoryUrl(comparison.submissionId2)" 
                         target="_blank" 
                         class="btn btn-sm btn-outline-primary me-1" 
                         title="Ver repositorio 2">
                        <i class="fab fa-github"></i>
                      </a>
                      <button 
                         class="btn btn-sm btn-outline-info" 
                         (click)="openComparisonHtml(comparison)"
                         title="Ver análisis detallado de similitud"
                         [disabled]="!comparison.comparisonHtmlUrl">
                        <i class="fas fa-search-plus me-1"></i>
                        <span *ngIf="comparison.comparisonHtmlUrl">HTML</span>
                        <span *ngIf="!comparison.comparisonHtmlUrl" class="text-muted">N/A</span>
                      </button>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- No Significant Similarities -->
        <div *ngIf="!originalityResults.comparisons || originalityResults.comparisons.length === 0" 
             class="alert alert-success">
          <i class="fas fa-check-circle me-2"></i>
          <strong>¡Excelente!</strong> No se encontraron similitudes significativas entre las entregas.
          <p class="mb-0 mt-2">
            <small>Esto indica que cada equipo ha desarrollado código original independiente.</small>
          </p>
        </div>

        <!-- Raw JSON Toggle -->
        <div class="mt-4">
          <button class="btn btn-outline-secondary btn-sm" (click)="toggleRawJson()">
            <i class="fas fa-code me-2"></i>
            {{ showRawJson ? 'Ocultar' : 'Mostrar' }} JSON Raw
          </button>
          
          <div class="mt-3" *ngIf="showRawJson">
            <div class="card">
              <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-code me-2"></i>Respuesta JSON Completa</h6>
              </div>
              <div class="card-body">
                <pre class="json-display">{{ originalityResults | json }}</pre>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- No submissions message -->
      <div class="alert alert-warning" *ngIf="!submissions || submissions.length === 0">
        <i class="fas fa-exclamation-triangle me-2"></i>
        No hay entregas disponibles para analizar.
      </div>

      <!-- Insufficient submissions message -->
      <div class="alert alert-warning" *ngIf="submissions && submissions.length === 1">
        <i class="fas fa-exclamation-triangle me-2"></i>
        Se necesitan al menos 2 entregas para realizar el análisis de originalidad.
        <br><small>Actualmente solo hay {{ submissions.length }} entrega disponible.</small>
      </div>
    </div>
  </div>
</div>

<!-- Modal para mostrar el reporte HTML -->
<div class="modal fade" 
     [class.show]="showReportModal" 
     [style.display]="showReportModal ? 'block' : 'none'"
     tabindex="-1" 
     role="dialog" 
     *ngIf="showReportModal">
  <div class="modal-dialog modal-xl" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-chart-bar me-2"></i>
          Reporte Detallado de Análisis de Plagio
        </h5>
        <button type="button" class="btn-close" (click)="closeReportModal()"></button>
      </div>
      <div class="modal-body p-0">
        <div class="report-container" [innerHTML]="reportHtmlContent" style="min-height: 600px; overflow-y: auto;">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeReportModal()">
          <i class="fas fa-times me-2"></i>Cerrar
        </button>
        <button type="button" class="btn btn-primary" (click)="openReportInNewWindow()">
          <i class="fas fa-external-link-alt me-2"></i>Abrir en Nueva Ventana
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Backdrop del modal -->
<div class="modal-backdrop fade" 
     [class.show]="showReportModal" 
     *ngIf="showReportModal"
     (click)="closeReportModal()">
</div>