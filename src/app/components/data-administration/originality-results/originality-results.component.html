<div class="originality-analysis">
  <div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h5 class="mb-0">
        <i class="fas fa-search-plus"></i>
        Análisis de Originalidad
      </h5>
      <div class="header-actions">
        <span class="badge me-2" 
              [style.background-color]="jplagHealthy ? '#28a745' : '#dc3545'"
              [title]="jplagHealthy ? 'Servicio JPlag disponible' : 'Servicio JPlag no disponible'">
          <i class="fas" [class.fa-check-circle]="jplagHealthy" [class.fa-exclamation-circle]="!jplagHealthy"></i>
          {{ jplagHealthy ? 'Servicio OK' : 'Servicio OFF' }}
        </span>
        <button 
          class="btn btn-primary"
          [disabled]="loading || !submissions || submissions.length < 2 || !jplagHealthy"
          (click)="analyzeOriginality()">
          <i class="fas fa-play" *ngIf="!loading"></i>
          <i class="fas fa-spinner fa-spin" *ngIf="loading"></i>
          {{ loading ? 'Analizando...' : 'Analizar Originalidad' }}
        </button>
      </div>
    </div>
    
    <div class="card-body">
      <!-- Requirements Info -->
      <div class="alert alert-info mb-3" *ngIf="!originalityResults">
        <h6><i class="fas fa-info-circle"></i> Análisis de Originalidad con JPlag</h6>
        <p class="mb-2">Este análisis detecta similitudes en el código fuente entre diferentes entregas usando la herramienta JPlag.</p>
        <ul class="mb-0">
          <li><strong>Repositorios requeridos:</strong> Mínimo 2 entregas</li>
          <li><strong>Idioma soportado:</strong> Java</li>
          <li><strong>Tiempo estimado:</strong> 1-3 minutos dependiendo del tamaño de los repositorios</li>
        </ul>
      </div>

      <!-- Submissions Info -->
      <div class="alert alert-light border mb-3" *ngIf="submissions && submissions.length > 0">
        <h6><i class="fas fa-list"></i> Entregas a Analizar</h6>
        <p class="mb-2"><strong>{{ submissions.length }}</strong> entregas seleccionadas:</p>
        <div class="row">
          <div class="col-md-6" *ngFor="let submission of submissions; let i = index">
            <div class="submission-item mb-2">
              <i class="fas fa-users me-2"></i>
              <strong>{{ submission.teamName }}</strong>
              <small class="text-muted d-block ms-3">
                <i class="fab fa-github me-1"></i>
                <a [href]="submission.repositoryUrl" target="_blank" class="text-decoration-none">
                  {{ submission.repositoryUrl }}
                </a>
              </small>
            </div>
          </div>
        </div>
      </div>

      <!-- Error Message -->
      <div class="alert alert-danger" *ngIf="error">
        <i class="fas fa-exclamation-triangle"></i>
        {{ error }}
        <div class="mt-2" *ngIf="!jplagHealthy">
          <small>
            <strong>Sugerencia:</strong> Verifica que el servicio JPlag esté ejecutándose en el puerto 8082.
          </small>
        </div>
      </div>

      <!-- Loading State -->
      <div class="text-center py-4" *ngIf="loading">
        <div class="spinner-border text-primary mb-3" role="status">
          <span class="visually-hidden">Analizando...</span>
        </div>
        <h6>Analizando originalidad...</h6>
        <p class="text-muted">
          <i class="fas fa-download me-2"></i>Clonando repositorios y analizando código fuente
        </p>
        <div class="progress" style="height: 6px;">
          <div class="progress-bar progress-bar-animated progress-bar-striped" 
               style="width: 100%" role="progressbar"></div>
        </div>
      </div>

      <!-- Results -->
      <div *ngIf="originalityResults && !loading">
        <!-- Success Message -->
        <div class="alert alert-success mb-3" *ngIf="originalityResults.success">
          <i class="fas fa-check-circle me-2"></i>
          {{ originalityResults.message }}
        </div>
        
        <!-- Error Message from Response -->
        <div class="alert alert-warning mb-3" *ngIf="!originalityResults.success">
          <i class="fas fa-exclamation-triangle me-2"></i>
          {{ originalityResults.message }}
        </div>

        <!-- Summary Card -->
        <div class="alert mb-4" [style.background-color]="getOverallRiskColor() + '20'" 
             [style.border-color]="getOverallRiskColor()">
          <div class="row align-items-center">
            <div class="col-md-8">
              <h6><i class="fas fa-chart-pie me-2"></i> Resumen del Análisis</h6>
              <p class="mb-1"><strong>Assignment:</strong> {{ originalityResults.statistics.assignmentTitle || assignmentTitle }}</p>
              <p class="mb-1"><strong>Comparaciones realizadas:</strong> {{ originalityResults.similarities.length || 0 }}</p>
              <p class="mb-1"><strong>Promedio de similitud:</strong> {{ originalityResults.statistics.averageSimilarity.toFixed(1) || 0 }}%</p>
              <p class="mb-0"><strong>Nivel de riesgo general:</strong> 
                <span class="badge badge-pill ms-2" 
                      [style.background-color]="getOverallRiskColor()"
                      style="color: white;">
                  {{ getOverallRiskLevel() }}
                </span>
              </p>
            </div>
            <div class="col-md-4">
              <div class="risk-summary">
                <div class="risk-item" *ngIf="getRiskSummary().high > 0">
                  <span class="badge bg-danger">{{ getRiskSummary().high }} Alto riesgo</span>
                </div>
                <div class="risk-item" *ngIf="getRiskSummary().medium > 0">
                  <span class="badge bg-warning">{{ getRiskSummary().medium }} Riesgo medio</span>
                </div>
                <div class="risk-item" *ngIf="getRiskSummary().low > 0">
                  <span class="badge bg-info">{{ getRiskSummary().low }} Riesgo bajo</span>
                </div>
                <div class="risk-item" *ngIf="getRiskSummary().minimal > 0">
                  <span class="badge bg-success">{{ getRiskSummary().minimal }} Sin riesgo</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Comparisons Table -->
        <div *ngIf="originalityResults.similarities && originalityResults.similarities.length > 0">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h6><i class="fas fa-table me-2"></i>Comparaciones de Similitud</h6>
            <button class="btn btn-outline-success btn-sm" (click)="exportResults()">
              <i class="fas fa-download me-2"></i>Exportar CSV
            </button>
          </div>
          
          <div class="table-responsive">
            <table class="table table-striped table-hover">
              <thead class="table-dark">
                <tr>
                  <th width="25%">Equipo 1</th>
                  <th width="25%">Equipo 2</th>
                  <th width="15%">Similitud</th>
                  <th width="20%">Nivel de Riesgo</th>
                  <th width="15%">Acciones</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let comparison of originalityResults.similarities; let i = index"
                    [class]="'table-row-' + getSimilarityLevel(comparison.similarity).toLowerCase()">
                  <td>
                    <div class="team-info">
                      <strong>{{ getTeamName(comparison.submissionId1) }}</strong>
                      <small class="text-muted d-block">
                        ID: {{ comparison.submissionId1 }}
                      </small>
                    </div>
                  </td>
                  <td>
                    <div class="team-info">
                      <strong>{{ getTeamName(comparison.submissionId2) }}</strong>
                      <small class="text-muted d-block">
                        ID: {{ comparison.submissionId2 }}
                      </small>
                    </div>
                  </td>
                  <td>
                    <div class="similarity-display">
                      <span class="badge badge-pill fs-6" 
                            [style.background-color]="getSimilarityColor(comparison.similarity)"
                            style="color: white;">
                        {{ comparison.similarity.toFixed(1) }}%
                      </span>
                      <div class="progress mt-1" style="height: 4px;">
                        <div class="progress-bar" 
                             [style.width.%]="comparison.similarity"
                             [style.background-color]="getSimilarityColor(comparison.similarity)">
                        </div>
                      </div>
                    </div>
                  </td>
                  <td>
                    <span class="risk-level" [style.color]="getSimilarityColor(comparison.similarity)">
                      <i class="fas fa-exclamation-triangle me-1" *ngIf="comparison.similarity >= 60"></i>
                      <i class="fas fa-info-circle me-1" *ngIf="comparison.similarity < 60 && comparison.similarity >= 40"></i>
                      <i class="fas fa-check-circle me-1" *ngIf="comparison.similarity < 40"></i>
                      {{ getSimilarityLabel(comparison.similarity) }}
                    </span>
                  </td>
                  <td>
                    <div class="action-buttons">
                      <a [href]="getRepositoryUrl(comparison.submissionId1)" 
                         target="_blank" 
                         class="btn btn-sm btn-outline-primary me-1" 
                         title="Ver repositorio 1">
                        <i class="fab fa-github"></i>
                      </a>
                      <a [href]="getRepositoryUrl(comparison.submissionId2)" 
                         target="_blank" 
                         class="btn btn-sm btn-outline-primary" 
                         title="Ver repositorio 2">
                        <i class="fab fa-github"></i>
                      </a>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- No Significant Similarities -->
        <div *ngIf="!originalityResults.similarities || originalityResults.similarities.length === 0" 
             class="alert alert-success">
          <i class="fas fa-check-circle me-2"></i>
          <strong>¡Excelente!</strong> No se encontraron similitudes significativas entre las entregas.
          <p class="mb-0 mt-2">
            <small>Esto indica que cada equipo ha desarrollado código original independiente.</small>
          </p>
        </div>

        <!-- Raw JSON Toggle -->
        <div class="mt-4">
          <button class="btn btn-outline-secondary btn-sm" (click)="toggleRawJson()">
            <i class="fas fa-code me-2"></i>
            {{ showRawJson ? 'Ocultar' : 'Mostrar' }} JSON Raw
          </button>
          
          <div class="mt-3" *ngIf="showRawJson">
            <div class="card">
              <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-code me-2"></i>Respuesta JSON Completa</h6>
              </div>
              <div class="card-body">
                <pre class="json-display">{{ originalityResults | json }}</pre>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- No submissions message -->
      <div class="alert alert-warning" *ngIf="!submissions || submissions.length === 0">
        <i class="fas fa-exclamation-triangle me-2"></i>
        No hay entregas disponibles para analizar.
      </div>

      <!-- Insufficient submissions message -->
      <div class="alert alert-warning" *ngIf="submissions && submissions.length === 1">
        <i class="fas fa-exclamation-triangle me-2"></i>
        Se necesitan al menos 2 entregas para realizar el análisis de originalidad.
        <br><small>Actualmente solo hay {{ submissions.length }} entrega disponible.</small>
      </div>
    </div>
  </div>
</div>
